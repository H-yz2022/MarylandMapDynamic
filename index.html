<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>GitHub Pages Map</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-groupedlayercontrol/0.6.1/leaflet.groupedlayercontrol.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-groupedlayercontrol/0.6.1/leaflet.groupedlayercontrol.min.css" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .leaflet-container { font-size: 1rem; }
        .legend {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            font-size: 14px;
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        .foliumtooltip table { margin: auto; }
        .foliumtooltip tr { text-align: left; }
        .foliumtooltip th { padding: 2px; padding-right: 8px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        (async function() {
            // Fix: The array for setView was missing a closing bracket.
            const map = L.map('map').setView([39.20, -76.68], 10);

            // Add the base map tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // Grouped layer control setup
            let groupedOverlays = {
                "GeoJSON Layers": {}
            };
            
            // --- Helper function for tooltip content ---
            function createTooltipContent(properties) {
                const fields = ['TAZ_ID', 'TOWN', 'AREA', 'COUNTY', 'POP2019', 'HH2019', 'EMP2019', 'NRET2019'];
                let content = '<table class="foliumtooltip">';
                fields.forEach(field => {
                    const value = properties[field] !== undefined ? properties[field] : 'N/A';
                    content += `<tr><th>${field}:</th><td>${value}</td></tr>`;
                });
                content += '</table>';
                return content;
            }

            // --- Replicating the Population Density Colormap from Python ---
            const colorScale = (value) => {
                const max = 7215; // Max value from your Python code's logic
                if (value === 0 || value === null || value === undefined) return "#faded1";
                if (value < max * 0.1) return '#ffffcc';
                if (value < max * 0.2) return '#d9f0a3';
                if (value < max * 0.3) return '#addd8e';
                if (value < max * 0.4) return '#78c679';
                if (value < max * 0.5) return '#41ab5d';
                if (value < max * 0.6) return '#238443';
                if (value < max * 0.7) return '#006837';
                if (value < max * 0.8) return '#004529';
                return '#004529';
            };

            // --- Load and Add the TAZ GeoJSON Layer ---
            try {
                const tazResponse = await fetch('static/geojason/TAZ.geojson');
                if (!tazResponse.ok) {
                    throw new Error(`Failed to fetch TAZ.geojson: ${tazResponse.statusText}`);
                }
                const tazData = await tazResponse.json();

                // Add the layer to the map and save it to a variable
                const tazLayer = L.geoJSON(tazData, {
                    style: (feature) => ({
                        fillColor: colorScale(feature.properties.POP2019),
                        color: 'black',
                        weight: 0.5,
                        fillOpacity: 0.3,
                    }),
                    onEachFeature: (feature, layer) => {
                        // Highlight on hover
                        layer.on('mouseover', () => {
                            layer.setStyle({
                                color: 'blue',
                                weight: 4,
                            });
                        });
                        // Reset to original style on mouseout
                        layer.on('mouseout', () => {
                            tazLayer.resetStyle(layer);
                        });
                        // Bind the tooltip
                        layer.bindTooltip(createTooltipContent(feature.properties), {
                            sticky: true,
                            className: 'foliumtooltip'
                        });
                    }
                }).addTo(map);

                // Add the layer to the grouped layers control
                groupedOverlays["GeoJSON Layers"]["TAZ Population"] = tazLayer;
                updateLayerControl();

            } catch (error) {
                console.error("Error loading TAZ GeoJSON:", error);
            }

            // --- Load Zonehwy_Node_External_Time GeoJSON Data ---
            try {
                const nodesResponse = await fetch('static/geojason/Zonehwy_Node_External_Time.geojson');
                if (!nodesResponse.ok) {
                    throw new Error(`Failed to fetch Zonehwy_Node_External_Time.geojson: ${nodesResponse.statusText}`);
                }
                const nodesData = await nodesResponse.json();

                const nodeLayer = L.geoJson(nodesData, {
                    pointToLayer: (feature, latlng) => {
                        return L.circleMarker(latlng, {
                            radius: 8,
                            fillColor: "red",
                            color: "#000",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    },
                    onEachFeature: (feature, layer) => {
                        if (feature.properties) {
                            layer.bindTooltip("Node ID: " + feature.properties.Node_ID);
                        }
                    }
                }).addTo(map);
                
                groupedOverlays["GeoJSON Layers"]["Highway Nodes"] = nodeLayer;
                updateLayerControl();

            } catch (error) {
                console.error('Error loading Zonehwy_Node_External_Time.geojson:', error);
            }

            // --- Helper function to update the layer control ---
            function updateLayerControl() {
                // Check if both layers are present before creating the control
                if (groupedOverlays["GeoJSON Layers"]["TAZ Population"] && groupedOverlays["GeoJSON Layers"]["Highway Nodes"]) {
                    L.control.groupedLayers({}, groupedOverlays, { collapsed: false }).addTo(map);
                }
            }

            // --- Add Legend ---
            function addLegend() {
                const legend = L.control({ position: 'bottomright' });
                legend.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'info legend');
                    const grades = [0, 721.5, 1443, 2164.5, 2886, 3607.5, 4329, 5050.5, 5772];
                    const colors = ['#ffffcc', '#d9f0a3', '#addd8e', '#78c679', '#41ab5d', '#238443', '#006837', '#004529'];
                    const noDataColor = '#faded1';
                    
                    div.innerHTML += '<h4>Population 2019</h4>';
                    // Loop through the intervals and create a colored label for each
                    for (let i = 0; i < grades.length -1; i++) {
                        div.innerHTML +=
                            '<i style="background:' + colors[i] + '"></i> ' +
                            Math.round(grades[i]) + (grades[i + 1] ? '&ndash;' + Math.round(grades[i + 1] - 1) : '+') + '<br>';
                    }
                    div.innerHTML += '<i style="background:' + noDataColor + '"></i> No Data<br>';
                    return div;
                };
                legend.addTo(map);
            }
            addLegend();
        })();
    </script>
</body>
</html>
