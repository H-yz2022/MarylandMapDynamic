<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>GitHub Pages Map</title>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-groupedlayercontrol/0.6.1/leaflet.groupedlayercontrol.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-groupedlayercontrol/0.6.1/leaflet.groupedlayercontrol.min.css"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .leaflet-container { font-size: 1rem; }
        /* Style for the legend */
        .legend {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            font-size: 14px;
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        .foliumtooltip table { margin: auto; }
        .foliumtooltip tr { text-align: left; }
        .foliumtooltip th { padding: 2px; padding-right: 8px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        (async function() {
            // Initialize the map, setting its center location and initial zoom level, just like in your Python code.
            const map = L.map('map').setView([41.153380, -73.278997], 12);

            // Add the 'CartoDB positron' tile layer. This is the base map.
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // --- Function to create the tooltip HTML, similar to your GeoJsonTooltip in Python ---
            function createTooltipContent(properties) {
                const fields = ['TAZ_ID', 'TOWN', 'AREA', 'COUNTY', 'POP2019', 'HH2019', 'EMP2019', 'NRET2019'];
                let content = '';
                fields.forEach(field => {
                    const value = properties[field] !== undefined ? properties[field] : 'N/A';
                    content += `<b>${field}:</b> ${value}<br>`;
                });
                return content;
            }

            // --- Replicating the Population Density Colormap from Python ---
            // A simple JavaScript function to get a color based on the value.
            // This mimics your `branca.colormap.linear.YlGn_09.scale`.
            const colorScale = (value) => {
                const max = 7215; // Max value from your Python code's logic (taz.POP2019.max())
                if (value === 0) return "#faded1";
                if (value < max * 0.1) return '#ffffcc';
                if (value < max * 0.2) return '#d9f0a3';
                if (value < max * 0.3) return '#addd8e';
                if (value < max * 0.4) return '#78c679';
                if (value < max * 0.5) return '#41ab5d';
                if (value < max * 0.6) return '#238443';
                if (value < max * 0.7) return '#006837';
                if (value < max * 0.8) return '#004529';
                return '#004529';
            };

            // --- Load and Add the TAZ GeoJSON Layer ---
            try {
                // Fetch the GeoJSON data from your 'static' folder.
                const tazResponse = await fetch('static/TAZ.geojson');
                if (!tazResponse.ok) {
                    throw new Error(`Failed to fetch TAZ.geojson: ${tazResponse.statusText}`);
                }
                const tazData = await tazResponse.json();

                // Add the GeoJSON layer to the map with styling and tooltips.
                L.geoJSON(tazData, {
                    style: (feature) => ({
                        fillColor: colorScale(feature.properties.POP2019), // Apply the custom color scale
                        color: 'black',
                        weight: 0.5,
                        fillOpacity: 0.3,
                    }),
                    onEachFeature: (feature, layer) => {
                        // Highlight on hover
                        layer.on('mouseover', () => {
                            layer.setStyle({
                                color: 'blue',
                                weight: 4,
                            });
                        });
                        layer.on('mouseout', () => {
                            // Reset to original style when not hovered
                            L.geoJSON(feature, {
                                style: (f) => ({
                                    fillColor: colorScale(f.properties.POP2019),
                                    color: 'black',
                                    weight: 0.5,
                                    fillOpacity: 0.3,
                                })
                            }).setStyle(layer.feature, layer);
                        });
                        // Bind the tooltip
                        layer.bindTooltip(createTooltipContent(feature.properties));
                    }
                }).addTo(map);

            } catch (error) {
                console.error("Error loading TAZ GeoJSON:", error);
            }

        // --- Load Zonehwy_Node_External_Time GeoJSON Data ---
        fetch('static/geojason/Zonehwy_Node_External_Time.geojson')
            .then(response => response.json())
            .then(data => {
                const nodeLayer = L.geoJson(data, {
                    pointToLayer: (feature, latlng) => {
                        return L.circleMarker(latlng, {
                            radius: 8,
                            fillColor: "red",
                            color: "#000",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    },
                    onEachFeature: (feature, layer) => {
                        if (feature.properties) {
                            layer.bindTooltip("Node ID: " + feature.properties.Node_ID);
                        }
                    }
                });
                nodeLayer.addTo(map);
                groupedOverlays["GeoJSON Layers"]["Highway Nodes"] = nodeLayer;
                updateLayerControl();
            })
            .catch(error => console.error('Error loading Zonehwy_Node_External_Time.geojson:', error));

        // Helper function to update the layer control
        function updateLayerControl() {
            if (Object.keys(groupedOverlays["GeoJSON Layers"]).length === 2) {
                L.control.groupedLayers({}, groupedOverlays, { collapsed: false }).addTo(map);
            }
        }
        
        // Function to add a legend to the map
        function addLegend() {
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                const grades = [0, 721.5, 1443, 2164.5, 2886, 3607.5, 4329, 5050.5, 5772];
                const labels = [];
                const colors = ['#ffffcc', '#d9f0a3', '#addd8e', '#78c679', '#41ab5d', '#238443', '#006837', '#004529', '#faded1'];

                // loop through our density intervals and generate a label with a colored square for each interval
                for (let i = 0; i < grades.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + colors[i] + '"></i> ' +
                        (i === 0 ? '0' : Math.round(grades[i-1])) + (i === 0 ? '' : ' &ndash; ' + Math.round(grades[i])) + '<br>';
                }
                div.innerHTML += '<i style="background:#faded1"></i> No Data';
                return div;
            };
            legend.addTo(map);
        }
    </script>
</body>
</html>
