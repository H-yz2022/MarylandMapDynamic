<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Folium-style Map</title>
    <link rel="stylesheet" href="./static/lib/leaflet.css" />
    <script src="./static/lib/leaflet.js"></script>

    <link rel="stylesheet" href="./static/lib/Control.Fullscreen.css" />
    <script src="./static/lib/Control.Fullscreen.js"></script>

    <script src="./static/lib/Control.MiniMap.min.js"></script>
    <link rel="stylesheet" href="./static/lib/Control.MiniMap.min.css" />
    
    <script src="./static/lib/leaflet.timedimension.control.js"></script>
    <link rel="stylesheet" href="./static/lib/leaflet.timedimension.control.css" />
    
    <script src="./static/lib/leaflet-measure.min.js"></script>
    <link rel="stylesheet" href="./static/lib/leaflet-measure.min.css" />
    
    <script src="./static/lib/L.Control.MousePosition.js"></script>
    <link rel="stylesheet" href="./static/lib/L.Control.MousePosition.css" />

    <style>
        /* General body and map container styles */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #map {
            height: 95vh;
            width: 95vw;
            border-radius: 0px;
            box-shadow: 0 0px 0px rgba(0, 0, 0, 0.1);
            border: 0px solid #ddd;
        }

        /* Styles for the Leaflet control panel */
        .leaflet-control-container .leaflet-control-attribution,
        .leaflet-control-container .leaflet-control-scale {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Style for the timeline slider */
        .leaflet-timedimension-control-panel {
            background-color: rgba(255, 255, 255, 0.9) !important;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // --- STEP 1: FETCH GEOJSON DATA ---
            // Only fetching the necessary TAZ and nodes data.
            try {
                const [tazResponse, nodesTimeResponse] = await Promise.all([
                    fetch('./static/TAZ.geojson'),
                    fetch('./static/Zonehwy_Node_External_Time.geojson')
                ]);

                const tazData = await tazResponse.json();
                const nodesTimeData = await nodesTimeResponse.json();

                // --- STEP 2: CREATE THE MAP & LAYERS ---
                // Initialize the map centered on your location
                const map = L.map('map', {
                    fullscreenControl: true,
                    timeDimension: true,
                    center: [39.23, -76.68],
                    zoom: 10,
                    scrollWheelZoom: true,
                });

                // Add a base tile layer
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                    attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, © <a href="http://cartodb.com/attributions">CartoDB</a>'
                }).addTo(map);

                // Create a simple colormap function for TAZ areas
                const tazColorMap = (value) => {
                    if (value === 0) return '#faded1';
                    // Get min and max from the loaded data
                    const min = tazData.features.map(f => f.properties.TAZ_Area).reduce((a, b) => Math.min(a, b));
                    const max = tazData.features.map(f => f.properties.TAZ_Area).reduce((a, b) => Math.max(a, b));
                    const scale = (value - min) / (max - min);
                    const r = Math.floor(255 * (1 - scale));
                    const g = Math.floor(215 * scale);
                    const b = 0;
                    return `rgb(${r}, ${g}, ${b})`;
                };

                // Add TAZ polygon layer
                const tazLayer = L.geoJson(tazData, {
                    style: (feature) => {
                        return {
                            fillColor: tazColorMap(feature.properties.TAZ_Area),
                            color: 'black',
                            weight: 0.5,
                            fillOpacity: 0.4
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        layer.bindTooltip(`
                            <b>ACRES:</b> ${props.ACRES}<br>
                            <b>Name:</b> ${props.NAME}<br>
                            <b>STATE NAME:</b> ${props.STATE_NAME}<br>
                            <b>TAZ Area:</b> ${props.TAZ_Area}
                        `);
                    }
                }).addTo(map);

                // --- STEP 3: ADD THE TIME-BASED AADT LAYER ---
                // Get min/max AADT from the loaded data for the colormap
                const aadtValues = nodesTimeData.features.map(f => f.properties.AADT).filter(v => v !== null);
                const minAADT = Math.min(...aadtValues);
                const maxAADT = Math.max(...aadtValues);

                const aadtColorMap = (value) => {
                    const scale = (value - minAADT) / (maxAADT - minAADT);
                    const r = Math.floor(255 * scale);
                    const g = Math.floor(255 * (1 - scale));
                    const b = 0;
                    return `rgb(${r}, ${g}, ${b})`;
                };

                const aadtLayer = L.timeDimension.layer.geoJson(L.geoJson(nodesTimeData, {
                    pointToLayer: (feature, latlng) => {
                        const radius = Math.max(2, feature.properties.AADT / 10000);
                        return L.circleMarker(latlng, {
                            radius: radius,
                            fillColor: aadtColorMap(feature.properties.AADT),
                            color: '#000',
                            weight: 0,
                            opacity: 0,
                            fillOpacity: 0.7
                        });
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        layer.bindTooltip(`
                            <b>Year:</b> ${new Date(props.time).getFullYear()}<br>
                            <b>AADT:</b> ${props.AADT}
                        `);
                    }
                }), {
                    updateTimeDimension: true,
                    duration: 'P1Y',
                });
                aadtLayer.addTo(map);

                // --- STEP 4: ADD PLUGINS AND CONTROLS ---
                const osmUrl = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png';
                const osmAttrib = '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, © <a href="http://cartodb.com/attributions">CartoDB</a>';
                const osm2 = new L.TileLayer(osmUrl, {
                    minZoom: 0,
                    maxZoom: 13,
                    attribution: osmAttrib
                });
                const miniMap = new L.Control.MiniMap(osm2, {
                    toggleDisplay: true
                }).addTo(map);

                L.control.timeDimension({
                    position: 'bottomleft' // Or your desired position
                }).addTo(map);

                L.control.measure({
                    primaryLengthUnit: 'meters',
                    secondaryLengthUnit: 'kilometers',
                    primaryAreaUnit: 'sqmeters',
                    secondaryAreaUnit: 'ha',
                }).addTo(map);

                L.control.mousePosition({
                    position: 'bottomright',
                    separator: ' | ',
                    emptyString: 'Unavailable',
                    lngFirst: false,
                    numDigits: 4,
                }).addTo(map);

            } catch (error) {
                console.error('Error fetching GeoJSON data:', error);
                const mapDiv = document.getElementById('map');
                mapDiv.innerHTML = '<div style="text-align:center; padding-top:50px;">Failed to load map data. Please ensure the GeoJSON files are in the /static folder.</div>';
            }
        });
    </script>
</body>
</html>
